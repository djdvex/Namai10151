<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Generatorius su Supabase ir Stripe</title>
    <!-- Tailwind CSS iš CDN (CSS karkasas stiliams) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #1a1a2e; /* Tamsi naktinė mėlyna spalva */
            color: #e4e4e7;
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 800px;
        }
        .card {
            background-color: #27284b;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            background-color: #6415ff;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #5010cc;
        }
        .btn-secondary {
            background-color: #3b3c69;
            color: #c4c4e7;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b4c7c;
        }
        .input-style, .textarea-style {
            background-color: #3b3c69;
            color: #e4e4e7;
            border: none;
            border-radius: 8px;
            padding: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
    </style>
    <!-- Įkeliame Supabase (kliento pusės) ir Stripe.js -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="p-4 md:p-8 min-h-screen">
    <div class="container mx-auto">
        <header class="mb-8 flex justify-between items-center p-4 card">
            <h1 class="text-3xl font-bold text-white">Gemini Generatorius</h1>
            <div id="auth-status" class="flex items-center space-x-4">
                <!-- Autentifikacijos būsena ir mygtukai bus rodomi čia -->
            </div>
        </header>

        <!-- Kvotos ir Mokėjimų Informacija -->
        <div id="quota-display" class="card p-4 mb-8 hidden">
            <p class="text-lg font-semibold">Liko žinučių: <span id="remaining-count" class="text-yellow-400">0</span></p>
            <button id="buy-messages-btn" class="btn-primary px-4 py-2 mt-2">Pirkti daugiau žinučių</button>
            <p id="auth-info" class="text-sm mt-2 text-gray-400"></p>
        </div>

        <!-- Autentifikacijos Forma -->
        <div id="auth-container" class="card p-8 mb-8 mx-auto hidden" style="max-width: 400px;">
            <h2 class="text-xl font-bold mb-4">Prisijungimas / Registracija</h2>
            <input type="email" id="email" placeholder="El. paštas" class="input-style w-full mb-3" required>
            <input type="password" id="password" placeholder="Slaptažodis" class="input-style w-full mb-4" required>
            <button id="signup-btn" class="btn-primary w-full py-2 mb-2">Registruotis</button>
            <button id="signin-btn" class="btn-secondary w-full py-2">Prisijungti</button>
            <p id="auth-message" class="text-center mt-3 text-sm text-red-400"></p>
        </div>

        <!-- Generatoriaus Forma -->
        <div id="generator-container" class="card p-8 hidden">
            <h2 class="text-2xl font-bold mb-4">Generuoti Turinį</h2>

            <label for="prompt" class="block text-sm font-medium mb-1">Jūsų užklausa:</label>
            <textarea id="prompt" class="textarea-style w-full h-32 mb-4" placeholder="Parašykite straipsnį apie klimato kaitos poveikį Baltijos jūrai..."></textarea>

            <label for="system-instruction" class="block text-sm font-medium mb-1">Sistemos instrukcijos (Gemini persona):</label>
            <input type="text" id="system-instruction" class="input-style w-full mb-4" placeholder="Esi profesionalus gamtosaugos specialistas." value="Esi profesionalus gamtosaugos specialistas.">

            <button id="generate-btn" class="btn-primary w-full py-3 text-lg font-semibold">Generuoti turinį</button>

            <!-- Rezultatų Laukas -->
            <div id="result-container" class="mt-8">
                <p id="loading-message" class="text-center text-blue-400 hidden">Generuojama... Palaukite.</p>
                <div id="result-content" class="card p-4 mt-4 whitespace-pre-wrap text-sm" style="min-height: 50px;">
                    <!-- Rezultatai bus rodomi čia -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Kintamieji bus priskirti čia per Vercel/Supabase ENV
        const SUPABASE_URL = 'SUPABASE_URL_HERE'; // Pakeisti į process.env.SUPABASE_URL Vercel'e
        const SUPABASE_ANON_KEY = 'SUPABASE_ANON_KEY_HERE'; // Pakeisti į process.env.SUPABASE_ANON_KEY Vercel'e
        const STRIPE_PUBLISHABLE_KEY = 'STRIPE_PUBLISHABLE_KEY_HERE'; // Pakeisti į process.env.STRIPE_PUBLISHABLE_KEY Vercel'e
        
        // Pakeisti kintamųjų reikšmes, kai diegiama Vercel platformoje.
        // Jei Vercel leidžia, galite naudoti inline scriptą:
        /*
        const SUPABASE_URL = window.__SUPABASE_URL__;
        const SUPABASE_ANON_KEY = window.__SUPABASE_ANON_KEY__;
        const STRIPE_PUBLISHABLE_KEY = window.__STRIPE_PUBLISHABLE_KEY__;
        */

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

        // --- DOM ELEMENTAI ---
        const authContainer = document.getElementById('auth-container');
        const generatorContainer = document.getElementById('generator-container');
        const authStatus = document.getElementById('auth-status');
        const quotaDisplay = document.getElementById('quota-display');
        const remainingCount = document.getElementById('remaining-count');
        const authMessage = document.getElementById('auth-message');
        const promptInput = document.getElementById('prompt');
        const generateBtn = document.getElementById('generate-btn');
        const resultContent = document.getElementById('result-content');
        const loadingMessage = document.getElementById('loading-message');
        const buyMessagesBtn = document.getElementById('buy-messages-btn');

        let currentUserId = null;

        // --- FUNKCIJOS ---

        /**
         * Parodo naudotojo kvotą
         * @param {string} userId - prisijungusio naudotojo ID
         */
        async function fetchQuota(userId) {
            if (!userId) {
                remainingCount.textContent = 0;
                return;
            }

            // Kviečiame kvotos tikrinimo funkcija, kuri kviečia api/chat be prompt
            // Tai yra paprastas būdas gauti kvotą, bet efektyviau būtų tiesiogiai per Supabase
            // Tačiau tiesioginis kvietimas api/chat be prompt paprastesnis implementuoti.
            
            // Tiesioginis kvietimas į Supabase yra saugiausias kvotos gavimo būdas:
            try {
                const { data, error } = await supabase
                    .from('user_quotas')
                    .select('remaining_messages')
                    .eq('user_id', userId)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116: eilutė nerasta
                    console.error('Kvotos gavimo klaida:', error);
                    remainingCount.textContent = 'ERROR';
                    return;
                }
                
                const remaining = data ? data.remaining_messages : 20; // Naujam vartotojui duodame 20 nemokamų žinučių
                
                // Jei naujas vartotojas ir kvota dar nebuvo nustatyta, nustatome
                if (!data && remaining > 0) {
                     await supabase.from('user_quotas').insert([{ user_id: userId, remaining_messages: remaining }]);
                }

                remainingCount.textContent = remaining;
                generateBtn.disabled = remaining <= 0;
                generateBtn.textContent = remaining <= 0 ? 'Kvotą išnaudota' : 'Generuoti turinį';

            } catch (err) {
                 console.error('Kvotos gavimo klaida:', err);
                 remainingCount.textContent = 'ERROR';
            }
        }

        /**
         * Atnaujina vartotojo sąsają pagal autentifikacijos būseną.
         */
        function updateUI(session) {
            authStatus.innerHTML = '';
            
            if (session) {
                // PRISIJUNGĘS VARTOTOJAS
                currentUserId = session.user.id;

                authContainer.classList.add('hidden');
                generatorContainer.classList.remove('hidden');
                quotaDisplay.classList.remove('hidden');
                
                // Parodo el. paštą ir Atsijungimo mygtuką
                authStatus.innerHTML = `
                    <p class="text-sm font-medium">${session.user.email}</p>
                    <button id="signout-btn" class="btn-secondary px-3 py-1 text-sm">Atsijungti</button>
                `;
                document.getElementById('signout-btn').onclick = handleSignOut;
                
                fetchQuota(currentUserId);
            } else {
                // NEPRISIJUNGĘS VARTOTOJAS
                currentUserId = null;

                authContainer.classList.remove('hidden');
                generatorContainer.classList.add('hidden');
                quotaDisplay.classList.add('hidden');
            }
        }

        // --- AUTENTIFIKACIJOS TVARKYKLĖS ---

        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            authMessage.textContent = 'Registruojama...';
            const { data, error } = await supabase.auth.signUp({ email, password });

            if (error) {
                authMessage.textContent = 'Registracija nepavyko: ' + error.message;
            } else {
                authMessage.textContent = 'Sėkmingai užregistruota! Patikrinkite el. paštą, kad patvirtintumėte.';
            }
        }

        async function handleSignIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            authMessage.textContent = 'Prisijungiama...';
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                authMessage.textContent = 'Prisijungimas nepavyko: ' + error.message;
            } else {
                authMessage.textContent = '';
                updateUI(data.session); // Supabase listener atnaujins UI, bet galime atnaujinti ir čia.
            }
        }

        async function handleSignOut() {
            authMessage.textContent = 'Atsijungiama...';
            const { error } = await supabase.auth.signOut();

            if (error) {
                authMessage.textContent = 'Atsijungimas nepavyko: ' + error.message;
            } else {
                authMessage.textContent = '';
                updateUI(null);
                // Išvalyti sesiją ir vartotojo duomenis
            }
        }

        // --- GEMINI GENERAVIMO TVARKYKLĖ ---

        async function handleGenerate() {
            const currentPrompt = promptInput.value.trim();
            const systemInstruction = document.getElementById('system-instruction').value.trim();
            const supabaseToken = supabase.auth.session()?.access_token;

            if (!currentPrompt || !supabaseToken) {
                resultContent.textContent = "Įveskite užklausą ir įsitikinkite, kad esate prisijungęs.";
                return;
            }

            // UI atnaujinimas
            generateBtn.disabled = true;
            loadingMessage.classList.remove('hidden');
            resultContent.textContent = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: currentPrompt, 
                        systemInstruction: systemInstruction,
                        supabaseToken: supabaseToken 
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Klaida iš API (pvz., kvota baigėsi)
                    resultContent.textContent = 'Klaida generuojant: ' + (data.error || 'Nežinoma klaida.');
                    
                    if (data.remaining !== undefined) {
                        remainingCount.textContent = data.remaining;
                    }

                    if (data.error && data.error.includes('Quota exceeded')) {
                        // Jei kvota viršyta, atblokuojame pirkimo mygtuką
                        generateBtn.textContent = 'Kvotą išnaudota';
                    }

                } else {
                    // Sėkmė
                    resultContent.textContent = data.text;
                    remainingCount.textContent = data.remaining;
                    generateBtn.disabled = data.remaining <= 0;
                }

            } catch (error) {
                console.error('Fetch error:', error);
                resultContent.textContent = 'Nepavyko prisijungti prie serverio API.';
            } finally {
                loadingMessage.classList.add('hidden');
                generateBtn.disabled = remainingCount.textContent <= 0;
                if(remainingCount.textContent > 0) {
                     generateBtn.disabled = false;
                }
            }
        }
        
        // --- STRIPE MOKĖJIMŲ TVARKYKLĖ ---
        async function handleBuyMessages() {
             const userId = currentUserId;

            if (!userId) {
                alert('Pirmiausia turite prisijungti, kad galėtumėte pirkti žinutes.');
                return;
            }
            
            buyMessagesBtn.disabled = true;
            buyMessagesBtn.textContent = 'Ruošiama...';

            try {
                // Kviečiame Serverless funkciją, kuri sukurs Stripe Checkout sesiją
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId })
                });

                const data = await response.json();

                if (response.ok && data.url) {
                    // Nukreipiame vartotoją į Stripe apmokėjimo puslapį
                    window.location.href = data.url;
                } else {
                    alert('Klaida kuriant apmokėjimo sesiją: ' + (data.error || 'Nežinoma klaida.'));
                }

            } catch (error) {
                console.error('Mokėjimo klaida:', error);
                alert('Serverio klaida kuriant apmokėjimo sesiją.');
            } finally {
                buyMessagesBtn.disabled = false;
                buyMessagesBtn.textContent = 'Pirkti daugiau žinučių';
            }
        }


        // --- ĮVYKIŲ KLAUSYKLĖS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Prisijungimo/Registracijos mygtukai
            document.getElementById('signup-btn').onclick = handleSignUp;
            document.getElementById('signin-btn').onclick = handleSignIn;
            
            // Generavimo mygtukas
            generateBtn.onclick = handleGenerate;
            
            // Pirkimo mygtukas
            buyMessagesBtn.onclick = handleBuyMessages;

            // Supabase autentifikacijos būsenos klausyklė
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth event:', event);
                updateUI(session);
            });
            
            // Pradinis UI atnaujinimas
            supabase.auth.getSession().then(({ data: { session } }) => {
                updateUI(session);
            });
        });
    </script>
</body>
</html>
